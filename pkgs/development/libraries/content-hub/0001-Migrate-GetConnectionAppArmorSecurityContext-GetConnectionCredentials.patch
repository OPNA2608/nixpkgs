From 0d12d880b3ad829948f46274d162adac095b238f Mon Sep 17 00:00:00 2001
From: Puna2608 <opna2608@protonmail.com>
Date: Sun, 9 Apr 2023 15:14:14 +0200
Subject: [PATCH] Migrate from GetConnectionAppArmorSecurityContext to
 GetConnectionCredentials

See https://lists.ubuntu.com/archives/foundations-bugs/2015-August/250429.html for details.
Based on https://bazaar.launchpad.net/~online-accounts/ubuntu-system-settings-online-accounts/trunk/revision/397/online-accounts-service/utils.cpp
---
 src/com/lomiri/content/utils.cpp | 25 ++++++++++++++++++-------
 1 file changed, 18 insertions(+), 7 deletions(-)

diff --git a/src/com/lomiri/content/utils.cpp b/src/com/lomiri/content/utils.cpp
index 546f1d5..777ec7e 100644
--- a/src/com/lomiri/content/utils.cpp
+++ b/src/com/lomiri/content/utils.cpp
@@ -26,6 +26,8 @@
 #include <QtCore>
 #include <QtDBus/QDBusMessage>
 #include <QtDBus/QDBusConnection>
+#include <QtDBus/QDBusError>
+#include <QtDBus/QDBusReply>
 #include <QUrl>
 #include <lomiri/util/Dbus.h>
 
@@ -257,19 +259,28 @@ QString aa_profile(QString uniqueConnectionId, QString returnValueOnError = QStr
         QDBusMessage::createMethodCall("org.freedesktop.DBus",
                                        "/org/freedesktop/DBus",
                                        "org.freedesktop.DBus",
-                                       "GetConnectionAppArmorSecurityContext");
+                                       "GetConnectionCredentials");
     QString aaProfile;
     QVariantList args;
     args << uniqueConnectionId;
     msg.setArguments(args);
-    QDBusMessage reply =
+    QDBusReply<QVariantMap> reply =
         QDBusConnection::sessionBus().call(msg, QDBus::Block);
-    if (reply.type() == QDBusMessage::ReplyMessage) {
-        aaProfile = reply.arguments().value(0, QString()).toString();
-        TRACE() << "AppArmor Profile:" << aaProfile;
+    if (reply.isValid()) {
+        QVariantMap map = reply.value();
+        QByteArray context = map.value("LinuxSecurityLabel").toByteArray();
+        if (!context.isEmpty()) {
+            aa_splitcon(context.data(), NULL);
+            aaProfile = QString::fromUtf8(context);
+            TRACE() << "AppArmor Profile:" << aaProfile;
+        } else {
+            qWarning() << "No LinuxSecurityLabel found in AppArmor reply";
+            return returnValueOnError;
+        }
     } else {
-        qWarning() << "Error getting app ID:" << reply.errorName() <<
-            reply.errorMessage();
+        QDBusError error = reply.error();
+        qWarning() << "Error getting app ID:" << error.name() <<
+            error.message();
         return returnValueOnError;
     }
 
-- 
2.39.2

